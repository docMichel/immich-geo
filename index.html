<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ Gestionnaire GPS Photos Immich SANS CACHE</title>

    <!-- ANTI-CACHE : EmpÃªcher la mise en cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- CSS avec timestamp anti-cache -->
    <link rel="stylesheet" href="styles.css?v=" id="css-link">
</head>
<body>
    <div class="container">
        <!-- En-tÃªte avec boutons de dÃ©veloppement -->
        <header class="header">
            <h1>ğŸ“ Gestionnaire GPS Photos Immich</h1>
            <p>Gestion par mois - Copie/Colle GPS entre photos</p>

            <!-- Boutons de dÃ©veloppement -->
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button id="changeTokenBtn" class="btn"
                    style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                    ğŸ”‘ Changer le token d'API
                </button>
                <button id="clearCacheBtn" class="btn"
                    style="background: rgba(255,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.3);">
                    ğŸ—‘ï¸ Vider le cache
                </button>
                <button id="reloadAppBtn" class="btn"
                    style="background: rgba(0,255,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.3);">
                    ğŸ”„ Recharger l'app
                </button>
                <button id="debugInfoBtn" class="btn"
                    style="background: rgba(0,0,255,0.3); color: white; border: 1px solid rgba(255,255,255,0.3);">
                    ğŸ› Info Debug
                </button>
            </div>
        </header>

        <!-- Section de navigation par dates -->
        <section class="date-navigation">
            <h2>ğŸ“… Navigation par dates</h2>

            <div class="date-controls">
                <button id="loadPeriodsBtn" class="btn btn-primary">
                    ğŸ”„ Charger les pÃ©riodes disponibles
                </button>

                <div class="selectors" id="dateSelectors" style="display: none;">
                    <select id="yearSelect" disabled>
                        <option value="">SÃ©lectionner une annÃ©e...</option>
                    </select>

                    <select id="monthSelect" disabled>
                        <option value="">SÃ©lectionner un mois...</option>
                    </select>

                    <button id="loadPhotosBtn" class="btn btn-success" disabled>
                        ğŸ“¥ Charger les photos de ce mois
                    </button>
                </div>
            </div>

            <div id="periodInfo" class="info-box" style="display: none;"></div>
        </section>

        <!-- Indicateur de progression -->
        <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText"></div>
        </div>

        <!-- Statistiques -->
        <section class="stats" id="statsSection" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalPhotos">0</div>
                <div class="stat-label">Photos chargÃ©es</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="analyzedPhotos">0</div>
                <div class="stat-label">AnalysÃ©es</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="gpsPhotos">0</div>
                <div class="stat-label">Avec GPS</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="noGpsPhotos">0</div>
                <div class="stat-label">Sans GPS</div>
            </div>
        </section>

        <!-- ContrÃ´les des photos -->
        <section class="photo-controls" id="photoControls" style="display: none;">
            <h2>ğŸ–¼ï¸ Gestion des photos</h2>

            <div class="controls-row">
                <div class="filter-buttons">
                    <button class="btn btn-filter active" data-filter="all">Toutes</button>
                    <button class="btn btn-filter" data-filter="gps">Avec GPS</button>
                    <button class="btn btn-filter" data-filter="no-gps">Sans GPS</button>
                </div>

                <div class="action-buttons">
                    <button id="analyzeGpsBtn" class="btn btn-warning">
                        ğŸ” Analyser GPS dÃ©taillÃ©
                    </button>
                    <button id="copyModeBtn" class="btn btn-mode">
                        ğŸ“‹ Mode Copie GPS
                    </button>
                    <button id="pasteModeBtn" class="btn btn-mode" disabled>
                        ğŸ“ Mode Collage GPS
                    </button>
                </div>
            </div>

            <!-- Info GPS copiÃ© -->
            <div class="clipboard-info" id="clipboardInfo" style="display: none;">
                <div class="clipboard-content">
                    <span class="clipboard-icon">ğŸ“‹</span>
                    <div class="clipboard-details">
                        <div>GPS copiÃ© depuis : <strong id="clipboardSource"></strong></div>
                        <div>CoordonnÃ©es : <code id="clipboardCoords"></code></div>
                        <div class="clipboard-hint">Cliquez sur une photo sans GPS pour coller</div>
                    </div>
                    <button class="btn-clear" onclick="clearClipboard()">âœ•</button>
                </div>
            </div>
        </section>

        <!-- Grille des photos -->
        <section class="photos-section" id="photosSection" style="display: none;">
            <div class="photos-grid" id="photosGrid"></div>

            <!-- Pagination si beaucoup de photos -->
            <div class="pagination" id="pagination" style="display: none;">
                <button id="prevPageBtn" class="btn btn-secondary">â€¹ PrÃ©cÃ©dent</button>
                <span id="pageInfo">Page 1 sur 1</span>
                <button id="nextPageBtn" class="btn btn-secondary">Suivant â€º</button>
            </div>
        </section>

        <!-- Section d'export -->
        <section class="export-section" id="exportSection" style="display: none;">
            <h2>ğŸ“¥ Export des donnÃ©es GPS</h2>
            <div class="export-buttons">
                <button id="exportCsvBtn" class="btn btn-export">ğŸ“Š Export CSV</button>
                <button id="exportJsonBtn" class="btn btn-export">ğŸ“‹ Export JSON</button>
                <button id="exportKmlBtn" class="btn btn-export">ğŸ—ºï¸ Export KML</button>
            </div>
        </section>
    </div>

    <!-- Zone de messages -->
    <div id="messageContainer"></div>

    <!-- Modal de confirmation pour le collage GPS -->
    <div class="modal" id="confirmModal" style="display: none;">
        <div class="modal-content">
            <h3>ğŸ“ Confirmer le collage GPS</h3>
            <p>Voulez-vous vraiment coller les coordonnÃ©es GPS sur cette photo ?</p>
            <div class="modal-coords" id="modalCoords"></div>
            <div class="modal-buttons">
                <button class="btn btn-success" id="confirmPasteBtn">âœ… Confirmer</button>
                <button class="btn btn-secondary" id="cancelPasteBtn">âŒ Annuler</button>
            </div>
        </div>
    </div>

    <!-- Scripts avec timestamps anti-cache -->
    <script>
        // SYSTÃˆME ANTI-CACHE POUR DÃ‰VELOPPEMENT
        (function() {
            const timestamp = Date.now();
            console.log('ğŸ”„ Chargement avec timestamp anti-cache:', timestamp);

            // Mettre Ã  jour le CSS avec timestamp
            document.getElementById('css-link').href = 'styles.css?v=' + timestamp;

            // Fonction pour charger les scripts avec anti-cache
            function loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src + '?v=' + timestamp;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

            // Charger tous les scripts dans l'ordre
            async function loadAllScripts() {
                try {
                    console.log('ğŸ“¥ Chargement des scripts...');
                    await loadScript('api.js');
                    console.log('âœ… api.js chargÃ©');

                    await loadScript('ui.js');
                    console.log('âœ… ui.js chargÃ©');

                    await loadScript('photos.js');
                    console.log('âœ… photos.js chargÃ©');

                    await loadScript('gps.js');
                    console.log('âœ… gps.js chargÃ©');

                    await loadScript('app.js');
                    console.log('âœ… app.js chargÃ©');

                    console.log('ğŸ‰ Tous les scripts chargÃ©s avec succÃ¨s');

                    // Ajouter les gestionnaires pour les boutons de dÃ©veloppement
                    addDevButtons();

                } catch (error) {
                    console.error('âŒ Erreur chargement script:', error);
                    alert('Erreur de chargement des scripts. VÃ©rifiez la console.');
                }
            }

            // Ajouter les fonctionnalitÃ©s des boutons de dÃ©veloppement
            function addDevButtons() {
                // Bouton changer token
                document.getElementById('changeTokenBtn').addEventListener('click', async function() {
                    console.log('ğŸ”‘ Clic sur bouton token');
                    console.log('- window.immichAPI existe:', !!window.immichAPI);
                    console.log('- immichAPI global existe:', typeof immichAPI !== 'undefined');
                    
                    // Attendre que l'API soit disponible si nÃ©cessaire
                    let apiInstance = window.immichAPI;
                    if (!apiInstance && typeof immichAPI !== 'undefined') {
                        apiInstance = immichAPI;
                    }
                    
                    // Si toujours pas disponible, attendre un peu
                    if (!apiInstance) {
                        console.log('â³ API non disponible, attente...');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        apiInstance = window.immichAPI || (typeof immichAPI !== 'undefined' ? immichAPI : null);
                    }
                    
                    if (!apiInstance) {
                        alert('API non initialisÃ©e. Attendez quelques secondes et rÃ©essayez, ou rechargez la page.');
                        return;
                    }
                    
                    if (confirm('Voulez-vous supprimer le token actuel et en saisir un nouveau ?')) {
                        try {
                            // Supprimer le token actuel
                            localStorage.removeItem('immich_api_key');
                            apiInstance.setApiKey(null);
                            
                            console.log('ğŸ”„ Demande nouveau token...');
                            
                            // Forcer une nouvelle demande de token
                            const success = await apiInstance.promptForApiKey();
                            
                            if (success) {
                                alert('Nouveau token configurÃ© avec succÃ¨s !');
                                // Optionnel : recharger l'app
                                if (confirm('Recharger l\'application pour appliquer le nouveau token ?')) {
                                    location.reload();
                                }
                            } else {
                                alert('Configuration du token annulÃ©e.');
                            }
                        } catch (error) {
                            console.error('âŒ Erreur:', error);
                            alert('Erreur: ' + error.message);
                        }
                    }
                });

                // Bouton vider cache
                document.getElementById('clearCacheBtn').addEventListener('click', function() {
                    if (confirm('Vider tout le cache du navigateur pour cette application ?')) {
                        // Vider localStorage
                        Object.keys(localStorage).forEach(key => {
                            if (key.includes('immich') || key.includes('gps')) {
                                localStorage.removeItem(key);
                            }
                        });

                        // Vider sessionStorage
                        sessionStorage.clear();

                        // Tenter de vider le cache du navigateur
                        if ('caches' in window) {
                            caches.keys().then(names => {
                                names.forEach(name => {
                                    caches.delete(name);
                                });
                            });
                        }

                        alert('Cache vidÃ© ! La page va se recharger.');
                        location.reload(true);
                    }
                });

                // Bouton recharger app
                document.getElementById('reloadAppBtn').addEventListener('click', function() {
                    location.reload(true);
                });

                // Bouton debug info
                document.getElementById('debugInfoBtn').addEventListener('click', function() {
                    const info = {
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        localStorage: Object.keys(localStorage).filter(k => k.includes('immich') || k.includes('gps')),
                        apiKey: localStorage.getItem('immich_api_key') ? 'PrÃ©sent (cachÃ©)' : 'Absent',
                        appState: window.debugApp ? window.debugApp.getState() : 'App non initialisÃ©e',
                        immichAPI: window.immichAPI ? {
                            hasKey: !!window.immichAPI.apiKey,
                            baseURL: window.immichAPI.baseURL
                        } : 'Non initialisÃ©'
                    };

                    console.log('ğŸ› DEBUG INFO:', info);
                    alert('Informations de debug dans la console (F12)');
                });

                console.log('ğŸ”§ Boutons de dÃ©veloppement activÃ©s');
            }

            // DÃ©marrer le chargement
            loadAllScripts();

            // Ajouter des raccourcis clavier pour le dÃ©veloppement
            document.addEventListener('keydown', function(e) {
                // Ctrl+Shift+R : Rechargement forcÃ©
                if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                    e.preventDefault();
                    location.reload(true);
                }

                // Ctrl+Shift+C : Vider cache
                if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                    e.preventDefault();
                    document.getElementById('clearCacheBtn').click();
                }

                // Ctrl+Shift+D : Debug info
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    e.preventDefault();
                    document.getElementById('debugInfoBtn').click();
                }
            });

        })();

        // Fonctions globales de debug et de secours
        window.forceTokenChange = async function() {
            try {
                console.log('ğŸ”‘ ForÃ§age du changement de token...');
                
                // Chercher l'instance API de toutes les faÃ§ons possibles
                let apiInstance = window.immichAPI || (typeof immichAPI !== 'undefined' ? immichAPI : null);
                
                if (!apiInstance) {
                    console.log('âš ï¸ Aucune instance API trouvÃ©e, crÃ©ation d\'une nouvelle...');
                    
                    // VÃ©rifier si la classe ImmichAPI existe
                    if (typeof ImmichAPI !== 'undefined') {
                        apiInstance = new ImmichAPI();
                        window.immichAPI = apiInstance;
                        console.log('âœ… Nouvelle instance API crÃ©Ã©e');
                    } else {
                        alert('Classes API non chargÃ©es. Rechargez la page et attendez le chargement complet.');
                        return false;
                    }
                }
                
                // Supprimer l'ancien token
                localStorage.removeItem('immich_api_key');
                apiInstance.setApiKey(null);
                
                // Demander le nouveau token
                const success = await apiInstance.promptForApiKey();
                
                if (success) {
                    console.log('âœ… Nouveau token configurÃ©');
                    
                    // Tester la connexion
                    try {
                        const isConnected = await apiInstance.testConnection();
                        console.log('ğŸ”— Test connexion:', isConnected);
                        alert('Token configurÃ© et testÃ© avec succÃ¨s !');
                    } catch (error) {
                        console.log('âš ï¸ Token configurÃ© mais test de connexion Ã©chouÃ©:', error.message);
                        alert('Token configurÃ©, mais vÃ©rifiez votre configuration Immich.');
                    }
                    
                    return true;
                } else {
                    console.log('âŒ Configuration annulÃ©e');
                    return false;
                }
                
            } catch (error) {
                console.error('âŒ Erreur changement token:', error);
                alert('Erreur: ' + error.message);
                return false;
            }
        };

        window.debugToken = function() {
            console.log('ğŸ” DEBUG TOKEN:');
            console.log('- localStorage token:', localStorage.getItem('immich_api_key') ? 'PrÃ©sent' : 'Absent');
            console.log('- window.immichAPI:', !!window.immichAPI);
            console.log('- global immichAPI:', typeof immichAPI !== 'undefined');
            console.log('- ImmichAPI class:', typeof ImmichAPI !== 'undefined');
            
            if (window.immichAPI) {
                console.log('- immichAPI.apiKey:', !!window.immichAPI.apiKey);
                console.log('- immichAPI.baseURL:', window.immichAPI.baseURL);
            }
            
            // Lister tous les objets globaux contenant 'immich'
            const globals = Object.keys(window).filter(key => key.toLowerCase().includes('immich'));
            console.log('- Objets globaux avec "immich":', globals);
        };

        // Fonction de diagnostic complet
        window.debugApp = function() {
            console.log('ğŸ” DEBUG APPLICATION:');
            console.log('===================');
            
            // Scripts chargÃ©s
            const scripts = Array.from(document.querySelectorAll('script[src]')).map(s => s.src);
            console.log('Scripts chargÃ©s:', scripts);
            
            // Classes disponibles
            const classes = ['ImmichAPI', 'UIManager', 'PhotosManager', 'GPSManager', 'ImmichGPSApp'];
            classes.forEach(className => {
                console.log(`- ${className}:`, typeof window[className] !== 'undefined');
            });
            
            // Instances globales
            const instances = ['immichAPI', 'ui', 'photosManager', 'gpsManager', 'app'];
            instances.forEach(instanceName => {
                console.log(`- ${instanceName}:`, typeof window[instanceName] !== 'undefined');
            });
            
            return {
                scriptsLoaded: scripts.length,
                classesAvailable: classes.filter(c => typeof window[c] !== 'undefined'),
                instancesAvailable: instances.filter(i => typeof window[i] !== 'undefined')
            };
        };
    </script>
</body>
</html>